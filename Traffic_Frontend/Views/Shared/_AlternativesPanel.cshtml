@* Alternatives Panel Partial - Enhanced UI *@
<style>
    .alternative-card {
        border-radius: 10px;
        transition: all 0.2s ease;
        border: 2px solid transparent;
        cursor: pointer;
    }
    .alternative-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .alternative-card.selected {
        border-color: #0d6efd;
        background: linear-gradient(135deg, #f0f7ff 0%, #e8f4fd 100%);
    }
    .alternative-card.recommended {
        border-color: #198754;
        background: linear-gradient(135deg, #f0fff4 0%, #e8f5e9 100%);
    }
    .route-badge {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
        color: white;
        flex-shrink: 0;
    }
    .metric-pill {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        background: #f1f5f9;
        color: #475569;
    }
    .metric-pill.good { background: #dcfce7; color: #166534; }
    .metric-pill.moderate { background: #fef3c7; color: #92400e; }
    .metric-pill.poor { background: #fee2e2; color: #991b1b; }
    .traffic-bar {
        height: 4px;
        border-radius: 2px;
        background: #e2e8f0;
        overflow: hidden;
    }
    .traffic-bar-fill {
        height: 100%;
        border-radius: 2px;
        transition: width 0.5s ease;
    }
    .recommended-badge {
        position: absolute;
        top: -8px;
        right: 10px;
        background: #198754;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
    }
    #altDetailsModal .metric-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f1f5f9;
    }
    #altDetailsModal .metric-row:last-child {
        border-bottom: none;
    }
    #altDetailsModal .metric-icon {
        width: 24px;
        text-align: center;
        color: #64748b;
    }
</style>

<div id="alternativesPanel">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="text-muted small" id="altPanelStatus">Draw a route to see alternatives</span>
        <button class="btn btn-sm btn-outline-secondary d-none" id="compareRoutesBtn" title="Compare Routes">
            <i class="bi bi-bar-chart-line"></i>
        </button>
    </div>
    <div id="alternativesList" class="d-grid gap-2">
        <div class="text-center text-muted py-3">
            <i class="bi bi-signpost-2 fs-3 d-block mb-2 opacity-50"></i>
            <span class="small">Run Analyze to see alternatives</span>
        </div>
    </div>
</div>

<script>
    console.log('[AlternativesPanel] Enhanced script loaded');
    
    const routeColors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
    let selectedAlternativeId = null;

    function getTrafficClass(score) {
        if (score === undefined || score === null) return 'moderate';
        if (score >= 0.7) return 'good';
        if (score >= 0.4) return 'moderate';
        return 'poor';
    }

    function getTrafficLabel(score) {
        if (score === undefined || score === null) return 'Unknown';
        if (score >= 0.7) return 'Light';
        if (score >= 0.4) return 'Moderate';
        return 'Heavy';
    }

    function formatDuration(minutes) {
        if (!minutes || minutes < 1) return '< 1 min';
        if (minutes < 60) return Math.round(minutes) + ' min';
        const hrs = Math.floor(minutes / 60);
        const mins = Math.round(minutes % 60);
        return hrs + 'h ' + (mins > 0 ? mins + 'm' : '');
    }

    function getEmissionIcon(emission) {
        if (!emission || emission < 300) return 'ðŸŒ±';
        if (emission < 600) return 'ðŸŒ¿';
        return 'ðŸ‚';
    }

    // Listen for alternatives event and render enhanced cards
    document.addEventListener('routes:alternatives', function(e) {
        console.log('[AlternativesPanel] routes:alternatives event received!', e.detail);
        try {
            const container = document.getElementById('alternativesList');
            const statusEl = document.getElementById('altPanelStatus');
            const compareBtn = document.getElementById('compareRoutesBtn');
            const detail = e.detail || {};
            const alts = detail.allAlternatives || [];
            const recommendedId = detail.recommendedAlternativeId;
            
            container.innerHTML = '';
            selectedAlternativeId = null;

            if (!alts.length) {
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-exclamation-circle fs-3 d-block mb-2 opacity-50"></i>
                        <span class="small">No alternatives found</span>
                    </div>`;
                statusEl.textContent = 'No routes available';
                compareBtn.classList.add('d-none');
                return;
            }

            statusEl.textContent = alts.length + ' alternative' + (alts.length > 1 ? 's' : '') + ' found';
            if (alts.length > 1) compareBtn.classList.remove('d-none');

            // Find best metrics for comparison
            const distances = alts.map(a => a.distance_km || a.lengthKm || 0);
            const times = alts.map(a => a.travel_time_min || 0);
            const minDist = Math.min(...distances.filter(d => d > 0));
            const minTime = Math.min(...times.filter(t => t > 0));

            alts.forEach((a, idx) => {
                const card = document.createElement('div');
                const routeId = a.id || a.routeId || a.rank || (idx + 1);
                const isRecommended = String(routeId) === String(recommendedId) || idx === 0;
                const distance = a.distance_km || a.lengthKm || 0;
                const travelTime = a.travel_time_min || Math.round(distance * 2);
                const trafficScore = a.traffic_score || a.suitabilityScore || 0.5;
                const emission = a.emission_g || Math.round(distance * 120);
                const displayName = a.name || ('Route ' + (a.rank || idx + 1));
                const color = routeColors[idx % routeColors.length];

                card.className = 'card alternative-card position-relative' + (isRecommended ? ' recommended' : '');
                card.dataset.routeId = routeId;
                
                card.innerHTML = 
                    (isRecommended ? '<span class="recommended-badge"><i class="bi bi-star-fill me-1"></i>Best</span>' : '') +
                    '<div class="card-body p-2">' +
                        '<div class="d-flex align-items-start gap-2 mb-2">' +
                            '<div class="route-badge" style="background: ' + color + ';">' + (idx + 1) + '</div>' +
                            '<div class="flex-grow-1">' +
                                '<div class="fw-semibold small">' + displayName + '</div>' +
                                '<div class="d-flex gap-1 flex-wrap mt-1">' +
                                    '<span class="metric-pill">' +
                                        '<i class="bi bi-geo-alt"></i> ' +
                                        distance.toFixed(2) + ' km' +
                                        (distance === minDist ? ' <i class="bi bi-trophy-fill text-warning"></i>' : '') +
                                    '</span>' +
                                    '<span class="metric-pill">' +
                                        '<i class="bi bi-clock"></i> ' +
                                        formatDuration(travelTime) +
                                        (travelTime === minTime ? ' <i class="bi bi-trophy-fill text-warning"></i>' : '') +
                                    '</span>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="d-flex justify-content-between align-items-center">' +
                            '<div class="d-flex gap-2 align-items-center">' +
                                '<span class="metric-pill ' + getTrafficClass(trafficScore) + '">' +
                                    '<i class="bi bi-car-front"></i> ' +
                                    getTrafficLabel(trafficScore) +
                                '</span>' +
                                '<span class="small" title="Estimated CO2">' + getEmissionIcon(emission) + ' ' + emission + 'g</span>' +
                            '</div>' +
                            '<div class="btn-group btn-group-sm">' +
                                '<button class="btn btn-outline-primary" data-route="' + routeId + '" data-action="select" title="Select this route">' +
                                    '<i class="bi bi-cursor"></i>' +
                                '</button>' +
                                '<button class="btn btn-outline-secondary" data-route="' + routeId + '" data-action="details" title="View details">' +
                                    '<i class="bi bi-info-circle"></i>' +
                                '</button>' +
                            '</div>' +
                        '</div>' +
                        '<div class="traffic-bar mt-2">' +
                            '<div class="traffic-bar-fill" style="width: ' + Math.round(trafficScore * 100) + '%; background: ' + (trafficScore >= 0.7 ? '#22c55e' : trafficScore >= 0.4 ? '#f59e0b' : '#ef4444') + ';"></div>' +
                        '</div>' +
                    '</div>';

                // Click on card to select
                card.addEventListener('click', function(evt) {
                    if (evt.target.closest('button')) return;
                    const selectBtn = card.querySelector('[data-action="select"]');
                    if (selectBtn) selectBtn.click();
                });

                container.appendChild(card);
            });
        } catch (err) { 
            console.warn('Could not render alternatives panel', err); 
        }
    });

    // Listen for selection events to highlight card
    document.addEventListener('routes:alternativeSelected', function(e) {
        try {
            const route = e.detail && e.detail.route;
            const routeId = route && (route.id || route.routeId || route.rank);
            if (!routeId) return;

            document.querySelectorAll('.alternative-card').forEach(function(card) {
                card.classList.remove('selected');
                if (card.dataset.routeId === String(routeId)) {
                    card.classList.add('selected');
                    selectedAlternativeId = routeId;
                }
            });
        } catch (err) { console.warn('Error updating selected card', err); }
    });

    // Enhanced modal HTML
    const altModalHtml = 
    '<div class="modal fade" id="altDetailsModal" tabindex="-1" aria-hidden="true">' +
      '<div class="modal-dialog modal-dialog-centered">' +
        '<div class="modal-content">' +
          '<div class="modal-header border-0 pb-0">' +
            '<div>' +
                '<h5 class="modal-title mb-0" id="altDetailsTitle">Route Details</h5>' +
                '<small class="text-muted" id="altDetailsSubtitle"></small>' +
            '</div>' +
            '<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>' +
          '</div>' +
          '<div class="modal-body pt-2">' +
            '<div class="row g-3 mb-3">' +
                '<div class="col-6">' +
                    '<div class="bg-light rounded-3 p-3 text-center">' +
                        '<i class="bi bi-geo-alt fs-4 text-primary"></i>' +
                        '<div class="fw-bold" id="altDetailsDistance">-</div>' +
                        '<small class="text-muted">Distance</small>' +
                    '</div>' +
                '</div>' +
                '<div class="col-6">' +
                    '<div class="bg-light rounded-3 p-3 text-center">' +
                        '<i class="bi bi-clock fs-4 text-success"></i>' +
                        '<div class="fw-bold" id="altDetailsTravelTime">-</div>' +
                        '<small class="text-muted">Est. Time</small>' +
                    '</div>' +
                '</div>' +
            '</div>' +
            '<div class="metric-row">' +
                '<div class="d-flex align-items-center gap-2">' +
                    '<span class="metric-icon"><i class="bi bi-car-front"></i></span>' +
                    '<span>Traffic Condition</span>' +
                '</div>' +
                '<div class="text-end">' +
                    '<span id="altDetailsTraffic" class="badge">-</span>' +
                '</div>' +
            '</div>' +
            '<div class="metric-row">' +
                '<div class="d-flex align-items-center gap-2">' +
                    '<span class="metric-icon"><i class="bi bi-cloud"></i></span>' +
                    '<span>COâ‚‚ Emissions</span>' +
                '</div>' +
                '<span id="altDetailsEmissions">-</span>' +
            '</div>' +
            '<div class="metric-row">' +
                '<div class="d-flex align-items-center gap-2">' +
                    '<span class="metric-icon"><i class="bi bi-fuel-pump"></i></span>' +
                    '<span>Est. Fuel Cost</span>' +
                '</div>' +
                '<span id="altDetailsFuel">-</span>' +
            '</div>' +
            '<div class="metric-row">' +
                '<div class="d-flex align-items-center gap-2">' +
                    '<span class="metric-icon"><i class="bi bi-signpost-split"></i></span>' +
                    '<span>Route Type</span>' +
                '</div>' +
                '<span id="altDetailsRoadType">-</span>' +
            '</div>' +
            '<div class="mt-3 p-2 bg-light rounded small text-muted d-none" id="altDetailsExtra"></div>' +
          '</div>' +
          '<div class="modal-footer border-0 pt-0">' +
            '<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>' +
            '<button type="button" class="btn btn-primary" id="altDetailsSelectBtn">' +
                '<i class="bi bi-cursor me-1"></i>Select Route' +
            '</button>' +
          '</div>' +
        '</div>' +
      '</div>' +
    '</div>';

    // Append modal to container once
    try {
        if (!document.getElementById('altDetailsModal')) {
            const wrapper = document.createElement('div');
            wrapper.innerHTML = altModalHtml;
            document.body.appendChild(wrapper.firstElementChild);
            
            // Wire up select button in modal
            document.getElementById('altDetailsSelectBtn').addEventListener('click', function() {
                const routeId = this.dataset.routeId;
                if (routeId) {
                    const selectBtn = document.querySelector('[data-route="' + routeId + '"][data-action="select"]');
                    if (selectBtn) selectBtn.click();
                    var modalInstance = bootstrap.Modal.getInstance(document.getElementById('altDetailsModal'));
                    if (modalInstance) modalInstance.hide();
                }
            });
        }
    } catch (err) { console.warn('Could not append alt details modal', err); }

    // Listen for details events
    document.addEventListener('routes:showAlternativeDetails', function(e) {
        try {
            const payload = e.detail || null;
            const modalEl = document.getElementById('altDetailsModal');
            
            if (!payload || !payload.raw) {
                if (modalEl) new bootstrap.Modal(modalEl).show();
                return;
            }

            const raw = payload.raw || {};
            const props = raw.properties || raw;
            const routeId = payload.id;

            const distance = props.distance_km || props.lengthKm || raw.distance_km || raw.lengthKm || 0;
            const travel = props.travel_time_min || props.travel_time || raw.travel_time_min || 0;
            const trafficScore = (props.traffic_score !== undefined) ? props.traffic_score : ((raw.traffic_score !== undefined) ? raw.traffic_score : 0.5);
            const emission = props.emission_g || raw.emission_g || Math.round(distance * 120);
            const name = props.name || raw.name || ('Route ' + (payload.id || ''));

            // Calculate derived values
            const fuelLiters = (distance * 0.08).toFixed(1);
            const fuelCost = (fuelLiters * 105).toFixed(0);

            document.getElementById('altDetailsTitle').textContent = name;
            document.getElementById('altDetailsSubtitle').textContent = 'Rank #' + (props.rank || raw.rank || routeId);
            document.getElementById('altDetailsDistance').textContent = distance.toFixed(2) + ' km';
            document.getElementById('altDetailsTravelTime').textContent = formatDuration(travel || distance * 2);
            
            var trafficBadge = document.getElementById('altDetailsTraffic');
            trafficBadge.textContent = getTrafficLabel(trafficScore);
            trafficBadge.className = 'badge bg-' + (trafficScore >= 0.7 ? 'success' : trafficScore >= 0.4 ? 'warning' : 'danger');
            
            document.getElementById('altDetailsEmissions').textContent = emission + 'g COâ‚‚';
            document.getElementById('altDetailsFuel').textContent = '~' + fuelLiters + 'L (â‚¹' + fuelCost + ')';
            document.getElementById('altDetailsRoadType').textContent = distance > 10 ? 'Highway' : distance > 5 ? 'Main Road' : 'Urban';
            
            var extra = document.getElementById('altDetailsExtra');
            if (props.summary || props.description) {
                extra.textContent = props.summary || props.description;
                extra.classList.remove('d-none');
            } else {
                extra.classList.add('d-none');
            }

            document.getElementById('altDetailsSelectBtn').dataset.routeId = routeId;

            if (modalEl) new bootstrap.Modal(modalEl).show();
        } catch (err) { 
            console.warn('Could not populate/show alt details modal', err); 
        }
    });

    // Compare routes button handler
    var compareBtn = document.getElementById('compareRoutesBtn');
    if (compareBtn) {
        compareBtn.addEventListener('click', function() {
            try {
                var alts = window.latestAlternatives || [];
                if (alts.length < 2) return;

                var html = '<div class="table-responsive"><table class="table table-sm table-bordered mb-0"><thead><tr><th>Route</th><th>Distance</th><th>Time</th><th>Traffic</th><th>COâ‚‚</th></tr></thead><tbody>';
                
                alts.forEach(function(a, idx) {
                    var distance = a.distance_km || a.lengthKm || 0;
                    var time = a.travel_time_min || Math.round(distance * 2);
                    var traffic = (a.traffic_score !== undefined) ? a.traffic_score : 0.5;
                    var emission = a.emission_g || Math.round(distance * 120);
                    
                    html += '<tr>' +
                        '<td><span class="badge" style="background: ' + routeColors[idx % routeColors.length] + '">' + (idx + 1) + '</span> ' + (a.name || 'Alt ' + (idx+1)) + '</td>' +
                        '<td>' + distance.toFixed(2) + ' km</td>' +
                        '<td>' + formatDuration(time) + '</td>' +
                        '<td><span class="badge bg-' + (traffic >= 0.7 ? 'success' : traffic >= 0.4 ? 'warning' : 'danger') + '">' + getTrafficLabel(traffic) + '</span></td>' +
                        '<td>' + emission + 'g</td>' +
                    '</tr>';
                });
                
                html += '</tbody></table></div>';

                var existingModal = document.getElementById('compareModal');
                if (existingModal) existingModal.remove();

                var modalHtml = 
                '<div class="modal fade" id="compareModal" tabindex="-1">' +
                    '<div class="modal-dialog modal-lg modal-dialog-centered">' +
                        '<div class="modal-content">' +
                            '<div class="modal-header">' +
                                '<h5 class="modal-title"><i class="bi bi-bar-chart-line me-2"></i>Route Comparison</h5>' +
                                '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>' +
                            '</div>' +
                            '<div class="modal-body">' + html + '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
                
                var wrapper = document.createElement('div');
                wrapper.innerHTML = modalHtml;
                document.body.appendChild(wrapper.firstElementChild);
                new bootstrap.Modal(document.getElementById('compareModal')).show();
            } catch (err) { console.warn('Could not show comparison', err); }
        });
    }
</script>
